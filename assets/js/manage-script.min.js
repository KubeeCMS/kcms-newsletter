mailster=function(c,f,m,o){"use strict";var h=f(".import-status"),l=f(".export-status"),g=f("#progress"),b=g.find(".bar"),e=f("#mailster_nonce").val(),t=null,s=0,v,i,n=function(){var r=new plupload.Uploader(wpUploaderInit);r.bind("Init",function(e){var t=f("#plupload-upload-ui");if(e.features.dragdrop&&!f(o.body).hasClass("mobile")){t.addClass("drag-drop");f("#drag-drop-area").bind("dragover.wp-uploader",function(){t.addClass("drag-over")}).bind("dragleave.wp-uploader, drop.wp-uploader",function(){t.removeClass("drag-over")})}else{t.removeClass("drag-drop");f("#drag-drop-area").unbind(".wp-uploader")}if(e.runtime=="html4")f(".upload-flash-bypass").hide()});r.bind("FilesAdded",function(e,t){f("#media-upload-error").html("");f("#wordpress-users").fadeOut();setTimeout(function(){e.refresh();e.start()},1)});r.bind("BeforeUpload",function(e,t){g.removeClass("finished error hidden");h.html("uploading")});r.bind("UploadFile",function(e,t){});r.bind("UploadProgress",function(e,t){h.html(c.util.sprintf(c.l10n.manage.uploading,t.percent+"%"));b.stop().animate({width:t.percent+"%"},100)});r.bind("Error",function(e,t){h.html(t.message);g.addClass("error");e.refresh()});r.bind("FileUploaded",function(e,t,n){n=JSON.parse(n.response);i=n.identifier;if(!n.success){h.html(n.message);g.addClass("error");e.refresh();r.unbind("UploadComplete")}});r.bind("UploadComplete",function(e,t){h.html(c.l10n.manage.prepare_data);g.addClass("finished");a()});r.init()};typeof wpUploaderInit=="object"&&c.events.push("documentReady",n);f(".wrap").on("change","#signup",function(){f("#signupdate").prop("disabled",!f(this).is(":checked"))}).on("click",".do-import",function(){var e=f("#lists").serialize(),t=f("#tags").serialize(),n=f("#subscriber-table").serialize();if(!/%5D=email/.test(n)){alert(c.l10n.manage.select_emailcolumn);return false}if(!f('input[name="status"]:checked').length){alert(c.l10n.manage.select_status);return false}if(!confirm(c.l10n.manage.confirm_import))return false;var r=f(this).prop("disabled",true),i=f('input[name="status"]:checked').val(),a=f('input[name="existing"]:checked').val(),s=f("#signup").is(":checked"),o=f("#signupdate").val(),l=f("#keepstatus").is(":checked"),d=f("#import-ajax-loading").css({display:"inline-block"}),u=f("#identifier").val(),p=f("#performance").is(":checked");g.removeClass("hidden");b.stop().width(0);f(".step1").slideUp();f(".step2-body").html("<br><br>").parent().show();v=new Date;_(0,{identifier:u,order:n,lists:e,tags:t,status:i,keepstatus:l,existing:a,signupdate:s?o:null,performance:p});h.html(c.l10n.manage.prepare_import);m.onbeforeunload=function(){return c.l10n.manage.onbeforeunloadimport}}).on("change",".wordpress-users-toggle",function(){f(this).parent().parent().parent().find("li input").prop("checked",f(this).prop("checked"))}).on("click","#addlist",function(){var e=f("#new_list_name").val();if(!e)return false;f('<li><label><input name="lists[]" value="'+e+'" type="checkbox" checked> '+e+" </label></li>").appendTo("#lists > ul");f("#new_list_name").val("")}).on("change",".list-toggle",function(){f(this).parent().parent().parent().find("ul input").prop("checked",f(this).prop("checked"))}).on("change",'input[name="status"]',function(){if(f(this).val()<=0){f(".pending-info").show()}else{f(".pending-info").hide()}});f("#paste-import").on("focus",function(){f(this).val("").addClass("focus")}).on("blur",function(){f(this).removeClass("focus");var e=c.util.trim(f(this).val());if(e){c.util.ajax("import_subscribers_upload_handler",{data:e},function(e){if(e.success){i=e.identifier;f("#wordpress-users").fadeOut();a()}else{h.html(e.message);g.addClass("error")}},function(){h.html("Error")})}});f("#import_wordpress").on("submit",function(){var e=f(this).serialize();c.util.ajax("import_subscribers_upload_handler",{wordpressusers:e},function(e){if(e.success){i=e.identifier;f("#wordpress-users").fadeOut();a()}else{h.html(e.message);g.addClass("error")}},function(){h.html("Error")});return false});f('select[name="outputformat"]').on("change",function(){f("#csv-separator")[f(this).val()=="csv"?"show":"hide"]()});c.events.push("documentReady",function(){f.fn.sortable&&f(".export-order").sortable({connectWith:".export-order",_placeholder:"ui-state-highlight",containment:".export-order-wrap",receive:function(e,t){t.item.find("input").prop("checked",t.item.closest(".export-order").is(".selected"))}}).on("change","input",function(){var e=f(this);e.parent().appendTo(e.is(":checked")?f(".export-order.selected"):f(".export-order.unselected"))})});f(".export-order-wrap").on("click",".export-order-add",function(){f(".export-order.unselected").find("li").appendTo(".export-order.selected").find("input").prop("checked",true);return false}).on("click",".export-order-remove",function(){f(".export-order.selected").find("li").appendTo(".export-order.unselected").find("input").prop("checked",false);return false});f("#export-subscribers").on("submit",function(){var n=f(this).serialize();c.util.ajax("export_contacts",{data:n},function(e){if(e.success){m.onbeforeunload=function(){return c.l10n.manage.onbeforeunloadexport};var t=f(".performance").val();f(".step2").slideDown();f(".step2-body").html(c.util.sprintf(c.l10n.manage.write_file,"0.00 Kb"));g.removeClass("finished error hidden");b.stop().width(0);d(0,t,e.count,n)}else{alert(e.msg)}},function(e,t,n){alert(t)});return false});f("#delete-subscribers").on("submit",function(){var e=prompt(c.l10n.manage.confirm_delete,"");if(!e)return false;if("delete"==e.toLowerCase()){var t=f(this).serialize();g.removeClass("finished error hidden");b.stop().animate({width:"99%"},25e3);c.util.ajax("delete_contacts",{data:t},function(e){if(e.success){b.stop().animate({width:"100%"},200,function(){f(".delete-status").html(e.msg);g.addClass("finished")})}else{b.stop();f(".delete-status").html(e.msg);g.addClass("error")}},function(e,t,n){b.stop();f(".delete-status").html("["+e.status+"] "+n);g.addClass("error")})}return false});f("#delete-subscribers").on("change","input, select",r);r();function r(){setTimeout(function(){var e=f("#delete-subscribers").serialize();f("#delete-subscriber-button").prop("disabled",true);c.util.ajax("get_subscriber_count",{data:e},function(e){if(e.success){f("#delete-subscriber-button").val(c.util.sprintf(c.l10n.manage.delete_n_subscribers,e.count)).prop("disabled",!e.count)}})},10)}f("input.selectall").on("change",function(){var e=f(this),t=e.attr("name");f('input[name="'+t+'"]').prop("checked",e.prop("checked"))});function d(n,r,i,a){var e=(new Date).getTime(),s=Math.min(1,r*n/i)*100;l.html(c.util.sprintf(c.l10n.manage.prepare_download,i,""));c.util.ajax("do_export",{limit:r,offset:n,data:a},function(e){var t=s>=100&&e.finished;if(e.success){if(!t)d(n+1,r,i,a);b.animate({width:s+"%"},{duration:1e3,easing:"swing",queue:false,step:function(e){l.html(c.util.sprintf(c.l10n.manage.prepare_download,i,Math.ceil(e)+"%"))},complete:function(){l.html(c.util.sprintf(c.l10n.manage.prepare_download,i,Math.ceil(s)+"%"));if(t){m.onbeforeunload=null;g.addClass("finished");f(".step2-body").html(c.l10n.manage.export_finished);l.html(c.util.sprintf(c.l10n.manage.downloading,i));if(e.filename)setTimeout(function(){o.location=e.filename},1e3)}else{f(".step2-body").html(c.util.sprintf(c.l10n.manage.write_file,e.total))}}})}else{b.stop();g.addClass("error");m.onbeforeunload=null;l.html(c.l10n.manage.error_export);f(".step2-body").html(e.msg)}},function(e,t,n){})}function _(r,i){var a=0;if(!r)r=0;c.util.ajax("do_import",{id:r,options:i},function(e){a=Math.min(1,(e.imported+e.errors)/e.total)*100;f(".step2-body").html("<p>"+p(e.f_imported,e.f_errors,e.f_total,a,e.memoryusage)+"</p>");s=0;var t=a>=100;if(e.success){if(!t)_(r+1,i);b.animate({width:a+"%"},{duration:1e3,easing:"swing",queue:false,step:function(e){h.html(c.util.sprintf(c.l10n.manage.import_contacts,Math.ceil(e)+"%"))},complete:function(){h.html(c.util.sprintf(c.l10n.manage.import_contacts,Math.ceil(a)+"%"));if(t){m.onbeforeunload=null;g.addClass("finished");f(".step2-body").html(e.html).slideDown()}}})}else{u(a,r,i)}},function(e,t,n){u(a,r,i)})}function a(){g.removeClass("finished error");c.util.ajax("get_import_data",{identifier:i},function(e){g.addClass("hidden");f(".step1").slideUp();f(".step2-body").html(e.html).parent().show();f("input.datepicker").datepicker({dateFormat:"yy-mm-dd",showAnim:"fadeIn",onClose:function(){}});f.fn.select2&&f(".tags-input").select2({placeholder:c.l10n.manage.choose_tags,tags:true,theme:"mailster"});h.html("");t=e.data})}function u(e,t,n){s++;if(s>=5){alert(c.l10n.manage.error_importing);m.onbeforeunload=null;return}var r=s*5,i="",a=setInterval(function(){if(r<=0){clearInterval(a);g.removeClass("paused");_(t,n);i=Math.round(e)+"%"}else{g.addClass("paused");i='<span class="error">'+c.util.sprintf(c.l10n.manage.continues_in,r--)+"</span>"}h.html(c.util.sprintf(c.l10n.manage.import_contacts,i))},1e3)}function p(e,t,n,r,i){var a=(new Date).getTime()-v.getTime(),s=Math.ceil((100-r)*(a/r)/6e4);return c.util.sprintf(c.l10n.manage.current_stats,"<strong>"+e+"</strong>","<strong>"+n+"</strong>","<strong>"+t+"</strong>","<strong>"+i+"</strong>")+"<br>"+c.util.sprintf(c.l10n.manage.estimate_time,s)}return c}(mailster||{},jQuery,window,document);